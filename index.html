<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CivicLens AI | Public Intelligence Command Center</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#070A13;
      --panel:#0E1426cc;
      --panel2:#0B1020cc;
      --stroke:#23304d;
      --text:#EAF0FF;
      --muted:#A7B3D6;
      --accent:#7C5CFF;
      --accent2:#2EE7FF;
      --good:#35E0A1;
      --warn:#FFD46B;
      --bad:#FF5C7A;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(46,231,255,.18), transparent 55%),
        radial-gradient(900px 600px at 40% 110%, rgba(255,92,122,.12), transparent 55%),
        linear-gradient(180deg, #050713 0%, #070A13 40%, #04050F 100%);
      overflow-x:hidden;
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,10,19,.72), rgba(7,10,19,.45));
      border-bottom: 1px solid rgba(35,48,77,.7);
    }
    .topbar .inner{
      max-width:1200px; margin:0 auto;
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: conic-gradient(from 200deg, var(--accent), var(--accent2), var(--bad), var(--accent));
      box-shadow: 0 10px 28px rgba(124,92,255,.25);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.38), transparent 50%);
      transform: rotate(18deg);
    }
    .titlewrap{display:flex; flex-direction:column; gap:2px}
    .titlewrap h1{margin:0; font-size:16px; letter-spacing:.3px}
    .titlewrap .sub{color:var(--muted); font-size:12px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(35,48,77,.9);
      background: rgba(14,20,38,.55);
      color: var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 0 rgba(53,224,161,.65);
      animation: pulse 2s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(53,224,161,.55)}
      70%{box-shadow:0 0 0 10px rgba(53,224,161,0)}
      100%{box-shadow:0 0 0 0 rgba(53,224,161,0)}
    }

    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid rgba(35,48,77,.9);
      background: rgba(14,20,38,.55);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      box-shadow: var(--shadow);
      font-weight:650;
      font-size:12px;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      user-select:none;
    }
    .btn:hover{border-color: rgba(124,92,255,.75)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(46,231,255,.75));
      color:#061021;
    }
    .btn.ghost{background:transparent; box-shadow:none}
    .wrap{max-width:1200px; margin:0 auto; padding:16px 18px 40px}
    .grid{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:14px;
      align-items:start;
    }
    .panel{
      background: var(--panel);
      border:1px solid rgba(35,48,77,.85);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .panel .hd{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom: 1px solid rgba(35,48,77,.7);
      background: linear-gradient(180deg, rgba(14,20,38,.55), rgba(14,20,38,.15));
    }
    .panel .hd h2{margin:0; font-size:12px; letter-spacing:.6px; color:var(--muted); text-transform:uppercase}
    .panel .bd{padding:14px}

    .controls label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    .row{display:flex; gap:10px}
    .chiprow{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(35,48,77,.9);
      background: rgba(11,16,32,.55);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease;
    }
    .chip:hover{border-color: rgba(46,231,255,.65)}
    .chip.active{border-color: rgba(124,92,255,.9); box-shadow: 0 0 0 3px rgba(124,92,255,.16) inset}
    select,input[type="range"]{
      width:100%;
      background: rgba(11,16,32,.55);
      border:1px solid rgba(35,48,77,.9);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    input[type="range"]{padding:0; height:34px}
    .hint{font-size:11px;color:var(--muted); line-height:1.35}
    .small{font-size:11px;color:var(--muted)}
    .divider{height:1px;background:rgba(35,48,77,.7);margin:12px 0}

    .main{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap:12px;
    }
    .kpi{
      background: var(--panel2);
      border:1px solid rgba(35,48,77,.85);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(400px 120px at 10% 20%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(300px 110px at 90% 30%, rgba(46,231,255,.14), transparent 60%);
      pointer-events:none;
    }
    .kpi .lbl{font-size:12px;color:var(--muted);position:relative}
    .kpi .val{font-size:26px;font-weight:800;margin-top:6px;position:relative; letter-spacing:.4px}
    .kpi .meta{font-size:11px;color:var(--muted); margin-top:6px; position:relative}
    .kpi .pill{
      position:absolute; top:12px; right:12px;
      padding:6px 10px;border-radius:999px;
      background: rgba(11,16,32,.55);
      border:1px solid rgba(35,48,77,.9);
      font-size:11px;color:var(--muted);
    }

    .two{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    .three{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .canvasWrap{height:260px}
    canvas{width:100% !important; height:100% !important}
    #map{height:320px;border-radius:14px;border:1px solid rgba(35,48,77,.85); overflow:hidden}
    .leaflet-control-attribution{display:none}

    .emerging{
      display:grid;
      grid-template-columns: repeat(3,1fr);
      gap:10px;
    }
    .cardMini{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(35,48,77,.85);
      background: rgba(11,16,32,.55);
      position:relative;
      overflow:hidden;
    }
    .cardMini strong{display:block;font-size:13px}
    .cardMini .delta{margin-top:6px;font-weight:800}
    .cardMini .loc{font-size:11px;color:var(--muted);margin-top:6px}
    .barline{
      position:absolute; left:0; right:0; bottom:0; height:4px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      opacity:.9;
    }
    .sev{
      display:inline-flex; align-items:center; gap:8px;
      font-size:11px; color:var(--muted); margin-top:8px;
    }
    .sev i{display:inline-block;width:10px;height:10px;border-radius:50%}
    .sev .r{background:var(--bad)}
    .sev .y{background:var(--warn)}
    .sev .g{background:var(--good)}

    .feed{
      max-height:320px; overflow:auto;
    }
    .item{
      padding:12px;
      border-bottom:1px solid rgba(35,48,77,.6);
      cursor:pointer;
      transition: background .15s ease;
    }
    .item:hover{background: rgba(124,92,255,.08)}
    .itemTop{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(35,48,77,.85);
      background: rgba(11,16,32,.55);
      font-size:11px;
      color: var(--muted);
      white-space:nowrap;
    }
    .sevPill{
      padding:6px 10px;border-radius:999px;font-weight:800;font-size:11px;
      color:#061021;
    }
    .sevHigh{background: var(--bad)}
    .sevMed{background: var(--warn)}
    .sevLow{background: var(--good)}
    .itemTitle{font-weight:800}
    .itemText{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35}
    .itemMeta{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; font-size:11px; color:var(--muted)}
    .muted{color:var(--muted)}

    .brief{
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size:12px;
      line-height:1.5;
      background: rgba(11,16,32,.55);
      border:1px solid rgba(35,48,77,.85);
      border-radius:16px;
      padding:12px;
      min-height:180px;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center;
      padding:18px;
      z-index:100;
    }
    .modal.open{display:flex}
    .modalBox{
      width:min(820px, 96vw);
      background: rgba(14,20,38,.92);
      border:1px solid rgba(35,48,77,.9);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modalHd{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(35,48,77,.7);
    }
    .modalHd strong{font-size:13px}
    .x{cursor:pointer; padding:6px 10px; border-radius:12px; border:1px solid rgba(35,48,77,.85); background: rgba(11,16,32,.55)}
    .modalBd{padding:14px; display:grid; grid-template-columns: 1.1fr .9fr; gap:12px}
    .box{
      background: rgba(11,16,32,.55);
      border:1px solid rgba(35,48,77,.85);
      border-radius:16px;
      padding:12px;
    }
    .box h4{margin:0 0 8px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.6px}
    .kv{display:grid; grid-template-columns: 140px 1fr; gap:8px; font-size:12px}
    .kv div{padding:6px 0; border-bottom:1px dashed rgba(35,48,77,.45)}
    .why li{margin:8px 0; color:var(--text); font-size:12px; line-height:1.35}
    .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .cta{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(35,48,77,.9);
      background: rgba(7,10,19,.35);
      font-size:12px; color:var(--text);
    }
    .cta strong{display:block; font-size:12px}
    .cta span{color:var(--muted); font-size:11px}

    /* responsive */
    @media(max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .kpis{grid-template-columns: repeat(2,1fr)}
      .two{grid-template-columns:1fr}
      .three{grid-template-columns:1fr}
      .emerging{grid-template-columns:1fr}
      .modalBd{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="logo"></div>
        <div class="titlewrap">
          <h1>CivicLens AI</h1>
          <div class="sub">Public Intelligence Command Center â€¢ Signals â†’ Insights â†’ Action</div>
        </div>
      </div>

      <div class="actions">
        <div class="badge"><span class="dot"></span><span id="freshness">Live simulation â€¢ Updating</span></div>
        <button class="btn ghost" id="btnPersona">Persona: NGO Analyst</button>
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn primary" id="btnExport">Export Brief</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: Controls -->
      <aside class="panel">
        <div class="hd"><h2>Sources & Filters</h2><span class="small" id="clock">â€”</span></div>
        <div class="bd controls">
          <div class="hint">
            This is a product-style demo. Data is simulated to demonstrate end-to-end public intelligence workflows.
          </div>

          <div class="divider"></div>

          <label>Data Sources</label>
          <div class="chiprow" id="sources">
            <div class="chip active" data-src="social">Social</div>
            <div class="chip active" data-src="hotline">Hotline</div>
            <div class="chip active" data-src="ngo">NGO Reports</div>
            <div class="chip" data-src="field">Field Officers</div>
          </div>

          <label>Time Window</label>
          <select id="timeWindow">
            <option value="7" selected>Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30">Last 30 days</option>
          </select>

          <label>Issue Category</label>
          <select id="category">
            <option value="All" selected>All categories</option>
            <option>Water & Sanitation</option>
            <option>Healthcare</option>
            <option>Electricity</option>
            <option>Security</option>
            <option>Corruption</option>
            <option>Transport & Roads</option>
            <option>Jobs & Cost of Living</option>
          </select>

          <label>Minimum Urgency (0â€“100)</label>
          <input id="urgencyMin" type="range" min="0" max="100" value="60"/>
          <div class="small">Current: <span id="urgencyMinVal">60</span></div>

          <div class="divider"></div>

          <label>Actions</label>
          <div class="row">
            <button class="btn" id="btnIngest">Ingest Signals</button>
            <button class="btn" id="btnVerify">Verification Queue</button>
          </div>
          <div class="hint" style="margin-top:10px">
            <b>Tip for demo video:</b> click an incident to open <i>AI explanation + recommended actions</i>.
          </div>
        </div>
      </aside>

      <!-- RIGHT: Main -->
      <main class="main">
        <!-- KPIs -->
        <section class="kpis">
          <div class="kpi">
            <div class="pill">Coverage</div>
            <div class="lbl">Total Signals</div>
            <div class="val" id="kpiSignals">0</div>
            <div class="meta" id="kpiSignalsMeta">â€”</div>
          </div>
          <div class="kpi">
            <div class="pill">Momentum</div>
            <div class="lbl">Emerging Issues</div>
            <div class="val" id="kpiEmerging">0</div>
            <div class="meta" id="kpiEmergingMeta">â€”</div>
          </div>
          <div class="kpi">
            <div class="pill">Hotspot</div>
            <div class="lbl">Top Hotspot</div>
            <div class="val" id="kpiHotspot">â€”</div>
            <div class="meta" id="kpiHotspotMeta">â€”</div>
          </div>
          <div class="kpi">
            <div class="pill">Severity</div>
            <div class="lbl">Avg Urgency</div>
            <div class="val" id="kpiUrgency">0%</div>
            <div class="meta" id="kpiUrgencyMeta">â€”</div>
          </div>
        </section>

        <!-- Emerging + Charts -->
        <section class="panel">
          <div class="hd"><h2>Emerging Signals</h2><span class="small" id="spikeNote">Spike detection enabled</span></div>
          <div class="bd">
            <div class="emerging" id="emergingCards"></div>
            <div class="divider"></div>
            <div class="two">
              <div class="panel" style="box-shadow:none; background:transparent; border:none">
                <div class="hd"><h2>Issue Distribution</h2><span class="small">by category</span></div>
                <div class="bd"><div class="canvasWrap"><canvas id="chartIssues"></canvas></div></div>
              </div>
              <div class="panel" style="box-shadow:none; background:transparent; border:none">
                <div class="hd"><h2>Trend</h2><span class="small">signals per day</span></div>
                <div class="bd"><div class="canvasWrap"><canvas id="chartTrend"></canvas></div></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Map + Feed + Brief -->
        <section class="three">
          <div class="panel">
            <div class="hd"><h2>Hotspot Map</h2><span class="small">click markers</span></div>
            <div class="bd"><div id="map"></div></div>
          </div>

          <div class="panel">
            <div class="hd"><h2>Live Incident Feed</h2><span class="small" id="feedCount">â€”</span></div>
            <div class="bd" style="padding:0">
              <div class="feed" id="feed"></div>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="hd"><h2>AI-Generated Public Brief</h2><span class="small">decision-ready</span></div>
          <div class="bd">
            <div class="brief" id="brief"></div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalBox">
      <div class="modalHd">
        <strong id="mTitle">Incident Detail</strong>
        <div class="x" id="mClose">Close</div>
      </div>
      <div class="modalBd">
        <div class="box">
          <h4>Signal</h4>
          <div class="kv" id="mKV"></div>
          <div class="divider"></div>
          <div class="muted" style="font-size:12px" id="mText"></div>
        </div>
        <div class="box">
          <h4>AI Explanation</h4>
          <ul class="why" id="mWhy"></ul>
          <div class="divider"></div>
          <h4>Recommended Actions</h4>
          <div class="ctaRow" id="mCTA"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   CivicLens AI WOW Demo Logic
---------------------------- */

const CATEGORIES = [
  "Water & Sanitation","Healthcare","Electricity","Security","Corruption","Transport & Roads","Jobs & Cost of Living"
];

const HOTSPOTS = [
  { name:"Dar es Salaam", lat:-6.816, lon:39.280 },
  { name:"Arusha", lat:-3.3869, lon:36.6830 },
  { name:"Dodoma", lat:-6.1630, lon:35.7516 },
  { name:"Morogoro", lat:-6.8278, lon:37.6591 },
  { name:"Mwanza", lat:-2.5164, lon:32.9175 },
  { name:"Mbeya", lat:-8.9094, lon:33.4608 }
];

const SOURCE_TYPES = ["social","hotline","ngo","field"];

const SEV = (u)=> u>=80 ? "High" : (u>=60 ? "Medium" : "Low");

const ACTIONS = {
  "Water & Sanitation": [
    {t:"Dispatch field verification", s:"Confirm outage scope & duration"},
    {t:"Coordinate utility response", s:"Target hotspot zones first"},
    {t:"Public update", s:"Share ETA & alternative access points"}
  ],
  "Healthcare": [
    {t:"Notify health partners", s:"Stockout / staffing alerts"},
    {t:"Prioritize supply chain", s:"Essential medicines & pediatrics"},
    {t:"Triage escalation", s:"Emergency coverage planning"}
  ],
  "Electricity": [
    {t:"Grid incident review", s:"Frequent outage pattern"},
    {t:"Protect critical services", s:"Hospitals & water systems"},
    {t:"Public advisory", s:"Time windows & safety tips"}
  ],
  "Security": [
    {t:"Route to security desk", s:"Threat validation"},
    {t:"Community alert", s:"Safety guidance"},
    {t:"Incident tracking", s:"Coordinate response units"}
  ],
  "Corruption": [
    {t:"Open audit case", s:"Flag suspicious service points"},
    {t:"Anonymous reporting", s:"Protect whistleblowers"},
    {t:"Compliance follow-up", s:"Process integrity checks"}
  ],
  "Transport & Roads": [
    {t:"Mark hazard locations", s:"Prevent accidents"},
    {t:"Maintenance dispatch", s:"Quick fixes first"},
    {t:"Reroute advisory", s:"Traffic & safety guidance"}
  ],
  "Jobs & Cost of Living": [
    {t:"Market monitoring", s:"Price spikes & shortages"},
    {t:"Targeted support", s:"High-pressure areas"},
    {t:"Policy brief", s:"Intervention options"}
  ],
  "Other":[
    {t:"Assign analyst review", s:"Categorize & route"},
    {t:"Request more data", s:"Validate with field checks"},
    {t:"Publish insight note", s:"Inform stakeholders"}
  ]
};

// English-only realistic incident text templates
const TEXT_TEMPLATES = {
  "Water & Sanitation": [
    "Residents report no running water for several days; queues are forming at remaining boreholes.",
    "Water supply is intermittent and contaminated; households report stomach illness risks.",
    "Broken pipeline suspected; neighborhood has been without water since the weekend."
  ],
  "Healthcare": [
    "Clinic reports medicine stockouts; patients are being turned away or asked to buy privately.",
    "Emergency ward is overwhelmed; long wait times reported across multiple facilities.",
    "Shortage of pediatric supplies reported; caregivers request urgent support."
  ],
  "Electricity": [
    "Frequent night outages reported; small businesses losing inventory and productivity.",
    "Voltage fluctuations damaging appliances; residents request immediate stabilization.",
    "Extended blackout affecting cold storage, clinics, and water pumps."
  ],
  "Security": [
    "Residents report increased theft incidents; requests for patrol presence rising.",
    "Unsafe areas reported after dark; community requests immediate intervention.",
    "Suspicious activity flagged near transport routes; public safety concerns escalating."
  ],
  "Corruption": [
    "Reports of unofficial fees for basic services; citizens request accountability.",
    "Bribery allegations during permit processing; delays linked to informal payments.",
    "Irregular service priority reported; transparency concerns increasing."
  ],
  "Transport & Roads": [
    "Potholes causing accidents; urgent repair requests rising after heavy rainfall.",
    "Traffic congestion increasing due to damaged road sections and limited signage.",
    "Bridge access restricted; commuters report long detours and safety risks."
  ],
  "Jobs & Cost of Living": [
    "Price increases reported on essential goods; households under pressure.",
    "Job seekers report rising scams and unfair recruitment fees.",
    "Rent spikes reported; communities request policy attention."
  ]
};

let personaIndex = 0;
const personas = [
  "NGO Analyst",
  "Government Response Desk",
  "Media Data Journalist",
  "Impact Investor"
];

const state = {
  timeWindow: 7,
  category: "All",
  urgencyMin: 60,
  sources: new Set(["social","hotline","ngo"]),
  items: [],
  lastTick: Date.now(),
};

function nowClock(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
document.getElementById("clock").textContent = nowClock();
setInterval(()=> document.getElementById("clock").textContent = nowClock(), 1000);

function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function pick(arr){ return arr[randInt(0, arr.length-1)]; }

function makeIncident(id){
  const cat = pick(CATEGORIES);
  const hs = pick(HOTSPOTS);
  const src = pick(SOURCE_TYPES);
  const u = Math.min(100, Math.max(0, Math.round(
    (cat==="Water & Sanitation" ? randInt(65,98) :
     cat==="Healthcare" ? randInt(55,92) :
     cat==="Electricity" ? randInt(45,88) :
     cat==="Security" ? randInt(50,90) :
     cat==="Corruption" ? randInt(40,86) :
     cat==="Transport & Roads" ? randInt(45,85) :
     randInt(35,80))
    + (src==="hotline" ? 6 : 0)
  )));
  const daysAgo = randInt(0, Math.max(1, state.timeWindow-1));
  const dt = new Date(Date.now() - daysAgo*24*3600*1000 - randInt(0, 6)*3600*1000);
  const dateStr = dt.toISOString().slice(0,10);

  const text = pick(TEXT_TEMPLATES[cat]);
  const why = [
    `Category confidence: ${(70 + randInt(0,25))}% (keyword + pattern match)`,
    `Urgency derived from severity terms + frequency + source credibility (${src})`,
    `Hotspot clustering: similar signals detected near ${hs.name} in the last ${state.timeWindow} days`
  ];

  return {
    id,
    category: cat,
    hotspot: hs.name,
    lat: hs.lat + (Math.random()-0.5)*0.18,
    lon: hs.lon + (Math.random()-0.5)*0.18,
    source: src,
    urgency: u,
    severity: SEV(u),
    date: dateStr,
    text,
    why,
  };
}

function ingest(n=18){
  const base = state.items.length ? state.items.length+1 : 1;
  for(let i=0;i<n;i++){
    state.items.push(makeIncident(base+i));
  }
}

function filtered(){
  return state.items.filter(it=>{
    if(!state.sources.has(it.source)) return false;
    if(state.category !== "All" && it.category !== state.category) return false;
    if(it.urgency < state.urgencyMin) return false;
    return true;
  }).sort((a,b)=> b.urgency - a.urgency);
}

function computeStats(items){
  const total = items.length;
  const avgUrg = total ? Math.round(items.reduce((s,x)=>s+x.urgency,0)/total) : 0;

  const byCat = {};
  const byHotspot = {};
  items.forEach(it=>{
    byCat[it.category] = (byCat[it.category]||0)+1;
    byHotspot[it.hotspot] = (byHotspot[it.hotspot]||0)+1;
  });
  const topHotspot = Object.entries(byHotspot).sort((a,b)=>b[1]-a[1])[0]?.[0] || "â€”";
  const topHotspotCount = Object.entries(byHotspot).sort((a,b)=>b[1]-a[1])[0]?.[1] || 0;

  return { total, avgUrg, byCat, byHotspot, topHotspot, topHotspotCount };
}

function sparkMeta(stats){
  const srcs = Array.from(state.sources).map(s=>s.toUpperCase()).join(", ");
  return `Sources: ${srcs || "None"} â€¢ Window: ${state.timeWindow}d â€¢ Filter: â‰¥${state.urgencyMin} urgency`;
}

function animateNumber(el, to, suffix=""){
  const from = Number(el.dataset.v || "0");
  const start = performance.now();
  const dur = 650;
  function step(t){
    const p = Math.min(1, (t-start)/dur);
    const val = Math.round(from + (to-from)*(1 - Math.pow(1-p,3)));
    el.textContent = `${val}${suffix}`;
    if(p<1) requestAnimationFrame(step);
    else el.dataset.v = String(to);
  }
  requestAnimationFrame(step);
}

/* Charts */
let issueChart, trendChart;

function buildTrend(items){
  const days = [];
  for(let i=state.timeWindow-1;i>=0;i--){
    const d = new Date(Date.now()-i*24*3600*1000);
    days.push(d.toISOString().slice(0,10));
  }
  const countByDay = Object.fromEntries(days.map(d=>[d,0]));
  items.forEach(it=>{
    if(countByDay[it.date] !== undefined) countByDay[it.date] += 1;
  });
  return { labels: days.map(d=>d.slice(5)), values: days.map(d=>countByDay[d]) };
}

function renderCharts(stats, items){
  const labels = Object.keys(stats.byCat);
  const values = labels.map(l=> stats.byCat[l]);

  const ctx1 = document.getElementById("chartIssues");
  if(issueChart) issueChart.destroy();
  issueChart = new Chart(ctx1, {
    type:"bar",
    data:{ labels, datasets:[{ label:"Signals", data: values }]},
    options:{
      responsive:true,
      plugins:{ legend:{display:false}},
      scales:{
        x:{ ticks:{ color:"#A7B3D6" }, grid:{ color:"rgba(35,48,77,.25)"}},
        y:{ ticks:{ color:"#A7B3D6" }, grid:{ color:"rgba(35,48,77,.25)"}}
      }
    }
  });

  const tr = buildTrend(items);
  const ctx2 = document.getElementById("chartTrend");
  if(trendChart) trendChart.destroy();
  trendChart = new Chart(ctx2, {
    type:"line",
    data:{ labels: tr.labels, datasets:[{ label:"Signals/day", data: tr.values, tension:.35 }]},
    options:{
      responsive:true,
      plugins:{ legend:{display:false}},
      scales:{
        x:{ ticks:{ color:"#A7B3D6" }, grid:{ color:"rgba(35,48,77,.25)"}},
        y:{ ticks:{ color:"#A7B3D6" }, grid:{ color:"rgba(35,48,77,.25)"}}
      }
    }
  });
}

/* Map */
let map, layer;
function initMap(){
  map = L.map("map", { zoomControl:false }).setView([-6.8, 39.2], 6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18 }).addTo(map);
  layer = L.layerGroup().addTo(map);
}
function renderMap(items){
  layer.clearLayers();
  const pts = items.filter(x=> typeof x.lat==="number" && typeof x.lon==="number");
  pts.slice(0, 60).forEach(it=>{
    const color = it.severity==="High" ? "#FF5C7A" : (it.severity==="Medium" ? "#FFD46B" : "#35E0A1");
    const marker = L.circleMarker([it.lat, it.lon], {
      radius: 7,
      color,
      weight: 2,
      fillColor: color,
      fillOpacity: 0.35
    }).addTo(layer);
    marker.bindPopup(`<b>${it.category}</b><br/>Urgency: <b>${it.urgency}</b><br/>${it.hotspot}<br/><i>${it.date}</i>`);
    marker.on("click", ()=> openModal(it));
  });
  if(pts.length){
    const bounds = L.latLngBounds(pts.map(p=>[p.lat,p.lon]));
    map.fitBounds(bounds.pad(0.25));
  }
}

/* Emerging cards (spike-ish heuristic) */
function computeEmerging(items){
  // simple heuristic: categories with highest count + elevated avg urgency
  const bucket = {};
  items.forEach(it=>{
    if(!bucket[it.category]) bucket[it.category] = {count:0, urgSum:0, topHot:{}};
    bucket[it.category].count++;
    bucket[it.category].urgSum += it.urgency;
    bucket[it.category].topHot[it.hotspot] = (bucket[it.category].topHot[it.hotspot]||0)+1;
  });

  const arr = Object.entries(bucket).map(([cat, v])=>{
    const avg = v.count ? v.urgSum / v.count : 0;
    const topHot = Object.entries(v.topHot).sort((a,b)=>b[1]-a[1])[0]?.[0] || "â€”";
    // fake delta for wow effect (based on momentum)
    const delta = Math.min(65, Math.max(6, Math.round((v.count*7) + (avg-50))));
    return {cat, count:v.count, avgUrg: Math.round(avg), topHot, delta};
  });

  arr.sort((a,b)=> (b.delta + b.count) - (a.delta + a.count));
  return arr.slice(0,3);
}

function renderEmerging(items){
  const cards = document.getElementById("emergingCards");
  cards.innerHTML = "";
  const top = computeEmerging(items);
  const colors = ["var(--bad)","var(--warn)","var(--accent2)"];
  top.forEach((x, idx)=>{
    const div = document.createElement("div");
    div.className = "cardMini";
    div.innerHTML = `
      <strong>${x.cat}</strong>
      <div class="sev"><i class="r"></i>High <i class="y"></i>Medium <i class="g"></i>Low</div>
      <div class="delta" style="color:${colors[idx]}">â†‘ ${x.delta}% momentum</div>
      <div class="muted" style="margin-top:6px;font-size:12px">${x.count} signals â€¢ Avg urgency ${x.avgUrg}</div>
      <div class="loc">Hotspot: ${x.topHot}</div>
      <div class="barline"></div>
    `;
    cards.appendChild(div);
  });
}

/* Feed */
function renderFeed(items){
  const feed = document.getElementById("feed");
  feed.innerHTML = "";
  document.getElementById("feedCount").textContent = `${items.length} filtered signals`;

  items.slice(0, 26).forEach(it=>{
    const sevClass = it.severity==="High" ? "sevHigh" : (it.severity==="Medium" ? "sevMed" : "sevLow");
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="itemTop">
        <div class="itemTitle">${it.category}</div>
        <div style="display:flex; gap:8px; align-items:center">
          <div class="tag">${it.hotspot} â€¢ ${it.source.toUpperCase()}</div>
          <div class="sevPill ${sevClass}">${it.severity} (${it.urgency})</div>
        </div>
      </div>
      <div class="itemText">${it.text}</div>
      <div class="itemMeta">
        <span>ðŸ“… ${it.date}</span>
        <span>ðŸ§­ Cluster: ${it.hotspot}</span>
        <span>ðŸ§  Explainable AI</span>
      </div>
    `;
    div.onclick = ()=> openModal(it);
    feed.appendChild(div);
  });

  if(items.length === 0){
    const empty = document.createElement("div");
    empty.style.padding="16px";
    empty.className="muted";
    empty.textContent="No signals match the current filters. Try lowering the urgency threshold or enabling more sources.";
    feed.appendChild(empty);
  }
}

/* Brief */
function renderBrief(items){
  const stats = computeStats(items);
  const topCats = Object.entries(stats.byCat).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const topCatsLine = topCats.length ? topCats.map(([c,n])=>`${c} (${n})`).join(", ") : "No dominant category detected";
  const severe = items.filter(x=>x.urgency>=80).slice(0,4);

  const persona = personas[personaIndex];

  const brief =
`PUBLIC INTELLIGENCE BRIEF (AUTO-GENERATED)
Persona: ${persona}
Window: Last ${state.timeWindow} days â€¢ Filters: ${state.category} â€¢ Urgency â‰¥ ${state.urgencyMin}
Sources: ${Array.from(state.sources).join(", ") || "none"}

EXECUTIVE SUMMARY
- Total signals analyzed: ${stats.total}
- Leading issues: ${topCatsLine}
- Primary hotspot: ${stats.topHotspot} (${stats.topHotspotCount} signals)
- Average urgency: ${stats.avgUrg} / 100

TOP URGENT SIGNALS
${severe.length ? severe.map(s=>`- [${s.urgency}/100] ${s.category} in ${s.hotspot} (${s.date})`).join("\n") : "- None above high-urgency threshold at this time."}

RECOMMENDED NEXT STEPS
- Verify high-urgency clusters with rapid field checks
- Route category-specific signals to response desks
- Publish clear public guidance to reduce panic and misinformation

Note: This is a decision-support brief generated from simulated public-style text inputs. Validate insights with field verification before enforcement actions.
`;
  document.getElementById("brief").textContent = brief;
}

/* Modal */
const modal = document.getElementById("modal");
document.getElementById("mClose").onclick = ()=> modal.classList.remove("open");
modal.addEventListener("click",(e)=>{ if(e.target===modal) modal.classList.remove("open"); });

function openModal(it){
  document.getElementById("mTitle").textContent = `${it.category} â€¢ ${it.hotspot} â€¢ ${it.severity} (${it.urgency})`;
  const kv = document.getElementById("mKV");
  kv.innerHTML = `
    <div class="muted">Date</div><div>${it.date}</div>
    <div class="muted">Source</div><div>${it.source.toUpperCase()}</div>
    <div class="muted">Hotspot</div><div>${it.hotspot}</div>
    <div class="muted">Urgency</div><div>${it.urgency} / 100</div>
    <div class="muted">Severity</div><div>${it.severity}</div>
  `;
  document.getElementById("mText").textContent = it.text;

  const why = document.getElementById("mWhy");
  why.innerHTML = "";
  it.why.forEach(w=>{
    const li = document.createElement("li");
    li.textContent = w;
    why.appendChild(li);
  });

  const cta = document.getElementById("mCTA");
  cta.innerHTML = "";
  const acts = ACTIONS[it.category] || ACTIONS["Other"];
  acts.forEach(a=>{
    const d = document.createElement("div");
    d.className = "cta";
    d.innerHTML = `<strong>${a.t}</strong><span>${a.s}</span>`;
    cta.appendChild(d);
  });

  modal.classList.add("open");
}

/* Render */
function render(){
  const items = filtered();
  const stats = computeStats(items);

  animateNumber(document.getElementById("kpiSignals"), stats.total);
  document.getElementById("kpiSignalsMeta").textContent = sparkMeta(stats);

  // emerging count = number of categories with "momentum" above threshold (heuristic)
  const emergArr = computeEmerging(items);
  animateNumber(document.getElementById("kpiEmerging"), emergArr.length);
  document.getElementById("kpiEmergingMeta").textContent = emergArr.length ? `Top momentum: ${emergArr[0].cat}` : "â€”";

  document.getElementById("kpiHotspot").textContent = stats.topHotspot;
  document.getElementById("kpiHotspotMeta").textContent = stats.topHotspotCount ? `${stats.topHotspotCount} signals in window` : "â€”";

  animateNumber(document.getElementById("kpiUrgency"), stats.avgUrg, "%");
  document.getElementById("kpiUrgencyMeta").textContent = stats.avgUrg>=80 ? "Critical pressure detected" : (stats.avgUrg>=60 ? "Elevated pressure" : "Stable signals");

  renderEmerging(items);
  renderCharts(stats, items);
  renderMap(items);
  renderFeed(items);
  renderBrief(items);
}

/* Controls */
document.getElementById("timeWindow").addEventListener("change", (e)=>{
  state.timeWindow = Number(e.target.value);
  // increase simulation volume slightly for longer windows
  ingest(10);
  render();
});
document.getElementById("category").addEventListener("change", (e)=>{
  state.category = e.target.value;
  render();
});
const urg = document.getElementById("urgencyMin");
urg.addEventListener("input", ()=>{
  state.urgencyMin = Number(urg.value);
  document.getElementById("urgencyMinVal").textContent = String(state.urgencyMin);
  render();
});

document.getElementById("btnIngest").onclick = ()=>{
  ingest(randInt(10,18));
  render();
};

document.getElementById("btnVerify").onclick = ()=>{
  alert("Verification Queue created âœ…\n\nTop high-urgency clusters have been routed for rapid field validation (demo action).");
};

document.getElementById("btnReset").onclick = ()=>{
  state.items = [];
  state.sources = new Set(["social","hotline","ngo"]);
  state.category = "All";
  state.urgencyMin = 60;
  document.getElementById("urgencyMin").value = "60";
  document.getElementById("urgencyMinVal").textContent = "60";
  document.getElementById("timeWindow").value = "7";
  document.getElementById("category").value = "All";
  // reset chips UI
  document.querySelectorAll("#sources .chip").forEach(ch=>{
    const src = ch.dataset.src;
    ch.classList.toggle("active", ["social","hotline","ngo"].includes(src));
  });
  ingest(22);
  render();
};

document.getElementById("btnExport").onclick = ()=>{
  // demo export (no server)
  const content = document.getElementById("brief").textContent;
  const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "CivicLens_AI_Public_Brief.txt";
  a.click();
  URL.revokeObjectURL(a.href);
};

document.getElementById("btnPersona").onclick = ()=>{
  personaIndex = (personaIndex+1) % personas.length;
  document.getElementById("btnPersona").textContent = `Persona: ${personas[personaIndex]}`;
  render();
};

// Source chips
document.querySelectorAll("#sources .chip").forEach(ch=>{
  ch.addEventListener("click", ()=>{
    const src = ch.dataset.src;
    if(state.sources.has(src)){
      state.sources.delete(src);
      ch.classList.remove("active");
    }else{
      state.sources.add(src);
      ch.classList.add("active");
    }
    render();
  });
});

// Freshness ticker + live simulation updates
function updateFreshness(){
  document.getElementById("freshness").textContent = `Live simulation â€¢ Updated at ${nowClock()}`;
}
setInterval(updateFreshness, 4000);

function liveTick(){
  // occasionally add new incidents to feel "live"
  ingest(randInt(2,5));
  render();
  updateFreshness();
}
setInterval(liveTick, 9000);

// init
initMap();
ingest(22);
render();
updateFreshness();
</script>
</body>
</html>
